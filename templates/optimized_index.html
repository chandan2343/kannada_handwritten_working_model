<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡≤ï‡≤®‡≥ç‡≤®‡≤° Handwritten Character Recognition</title>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --bg-light: #ffffff;
            --bg-dark: #1a1a2e;
            --text-light: #333;
            --text-dark: #e0e0e0;
            --card-bg-light: #ffffff;
            --card-bg-dark: #16213e;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --shadow-dark: 0 10px 30px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            transition: background 0.3s ease;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Sidebar */
        .sidebar {
            background: var(--card-bg-light);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            height: fit-content;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        body.dark-mode .sidebar {
            background: var(--card-bg-dark);
            box-shadow: var(--shadow-dark);
        }

        .sidebar h2 {
            color: var(--text-light);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
        }

        body.dark-mode .sidebar h2 {
            color: var(--text-dark);
        }

        .upload-option {
            margin-bottom: 15px;
            padding: 15px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        body.dark-mode .upload-option {
            border-color: #444;
        }

        .upload-option:hover {
            border-color: var(--primary-color);
            background-color: #f8f9ff;
        }

        body.dark-mode .upload-option:hover {
            background-color: #1e2746;
        }

        .upload-option.active {
            border-color: var(--primary-color);
            background-color: #f0f4ff;
        }

        body.dark-mode .upload-option.active {
            background-color: #1e2746;
        }

        .upload-option h3 {
            color: var(--text-light);
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        body.dark-mode .upload-option h3 {
            color: var(--text-dark);
        }

        .upload-option p {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        body.dark-mode .upload-option p {
            color: #aaa;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Drawing Canvas */
        .drawing-section {
            background: var(--card-bg-light);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        body.dark-mode .drawing-section {
            background: var(--card-bg-dark);
            box-shadow: var(--shadow-dark);
        }

        .drawing-section h3 {
            color: var(--text-light);
            margin-bottom: 15px;
            text-align: center;
        }

        body.dark-mode .drawing-section h3 {
            color: var(--text-dark);
        }

        .canvas-container {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }

        #drawingCanvas {
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: crosshair;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            touch-action: none;
        }

        body.dark-mode #drawingCanvas {
            border-color: #444;
            background: #2a2a3e;
        }

        .canvas-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .canvas-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .canvas-btn.clear {
            background: var(--danger-color);
            color: white;
        }

        .canvas-btn.recognize {
            background: var(--success-color);
            color: white;
        }

        .canvas-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        /* Main Content */
        .main-content {
            background: var(--card-bg-light);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        body.dark-mode .main-content {
            background: var(--card-bg-dark);
            box-shadow: var(--shadow-dark);
        }

        .image-viewer {
            text-align: center;
            margin-bottom: 20px;
        }

        .image-container {
            max-width: 100%;
            max-height: 500px;
            margin-bottom: 20px;
            display: inline-block;
        }

        .image-container img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .nav-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #5a6fd8;
            transform: scale(1.1);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .image-counter {
            color: var(--text-light);
            font-weight: bold;
        }

        body.dark-mode .image-counter {
            color: var(--text-dark);
        }

        .recognize-btn {
            background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            width: 100%;
        }

        .recognize-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .recognize-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Results */
        .results {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
            transition: background 0.3s ease;
        }

        body.dark-mode .results {
            background: #1e2746;
        }

        .results h3 {
            color: var(--text-light);
            margin-bottom: 15px;
            text-align: center;
        }

        body.dark-mode .results h3 {
            color: var(--text-dark);
        }

        .predicted-text {
            font-size: 3em;
            font-weight: bold;
            color: var(--text-light);
            margin-bottom: 20px;
            text-align: center;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Noto Sans Kannada', sans-serif;
        }

        body.dark-mode .predicted-text {
            color: var(--text-dark);
        }

        .confidence-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        body.dark-mode .confidence-bar {
            background: #2a2a3e;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), #20c997);
            border-radius: 15px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .top5-predictions {
            margin-top: 20px;
        }

        .top5-predictions h4 {
            color: var(--text-light);
            margin-bottom: 15px;
        }

        body.dark-mode .top5-predictions h4 {
            color: var(--text-dark);
        }

        .prediction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        body.dark-mode .prediction-item {
            background: #2a2a3e;
        }

        .prediction-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .prediction-char {
            font-size: 2em;
            font-weight: bold;
            color: var(--text-light);
            font-family: 'Noto Sans Kannada', sans-serif;
        }

        body.dark-mode .prediction-char {
            color: var(--text-dark);
        }

        .prediction-conf {
            color: #666;
            font-weight: bold;
        }

        body.dark-mode .prediction-conf {
            color: #aaa;
        }

        .tts-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .tts-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tts-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .download-btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            color: white;
        }

        .download-btn.text {
            background: var(--info-color);
        }

        .download-btn.pdf {
            background: var(--danger-color);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        /* History Sidebar */
        .history-sidebar {
            background: var(--card-bg-light);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            height: fit-content;
            max-height: 800px;
            overflow-y: auto;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        body.dark-mode .history-sidebar {
            background: var(--card-bg-dark);
            box-shadow: var(--shadow-dark);
        }

        .history-sidebar h3 {
            color: var(--text-light);
            margin-bottom: 15px;
            text-align: center;
        }

        body.dark-mode .history-sidebar h3 {
            color: var(--text-dark);
        }

        .history-item {
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        body.dark-mode .history-item {
            background: #2a2a3e;
        }

        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .history-char {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-light);
            margin-bottom: 5px;
            font-family: 'Noto Sans Kannada', sans-serif;
        }

        body.dark-mode .history-char {
            color: var(--text-dark);
        }

        .history-time {
            font-size: 0.8em;
            color: #666;
        }

        body.dark-mode .history-time {
            color: #aaa;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        body.dark-mode .error {
            background: #3d1e1e;
            color: #ff6b6b;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .predicted-text {
                font-size: 2em;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Kannada:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‡≤ï‡≤®‡≥ç‡≤®‡≤° Handwritten Character Recognition</h1>
            <button class="theme-toggle" onclick="toggleDarkMode()">üåô Dark Mode</button>
        </div>

        <div class="main-grid">
            <!-- Left Sidebar -->
            <div class="sidebar">
                <h2>üìÅ Upload Options</h2>
                
                <div class="upload-option" id="drawOption">
                    <h3>‚úèÔ∏è Draw Character</h3>
                    <p>Draw a Kannada character on the canvas</p>
                </div>

                <div class="upload-option" id="singleOption">
                    <h3>üì∑ Single Image</h3>
                    <p>Upload single image to recognize</p>
                    <input type="file" id="singleInput" class="file-input" accept="image/*">
                    <button class="btn" onclick="document.getElementById('singleInput').click()">
                        Choose Image
                    </button>
                </div>

                <div class="upload-option" id="multipleOption">
                    <h3>üñºÔ∏è Multiple Images</h3>
                    <p>Upload multiple images</p>
                    <input type="file" id="multipleInput" class="file-input" accept="image/*" multiple>
                    <button class="btn" onclick="document.getElementById('multipleInput').click()">
                        Choose Images
                    </button>
                </div>

                <div class="upload-option" id="pdfOption">
                    <h3>üìÑ PDF Document</h3>
                    <p>Upload PDF with up to 40 pages</p>
                    <input type="file" id="pdfInput" class="file-input" accept=".pdf">
                    <button class="btn" onclick="document.getElementById('pdfInput').click()">
                        Choose PDF
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Drawing Canvas Section -->
                <div class="drawing-section" id="drawingSection" style="display: none;">
                    <h3>Draw a Kannada Character</h3>
                    <div class="canvas-container">
                        <canvas id="drawingCanvas" width="400" height="400"></canvas>
                    </div>
                    <div class="canvas-controls">
                        <button class="canvas-btn clear" onclick="clearCanvas()">Clear</button>
                        <button class="canvas-btn recognize" onclick="recognizeDrawing()">Recognize</button>
                    </div>
                </div>

                <!-- Image Viewer -->
                <div class="image-viewer" id="imageViewer" style="display: none;">
                    <div class="image-container" id="imageContainer"></div>
                    <div class="navigation" id="navigation" style="display: none;">
                        <button class="nav-btn" id="prevBtn" onclick="navigate('prev')">‚Äπ</button>
                        <span class="image-counter" id="imageCounter">1 / 1</span>
                        <button class="nav-btn" id="nextBtn" onclick="navigate('next')">‚Ä∫</button>
                    </div>
                    <button class="recognize-btn" id="recognizeBtn" onclick="recognize()" disabled>
                        üîç Recognize Text
                    </button>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Processing...</p>
                </div>

                <div class="results" id="results">
                    <h3>Recognition Results</h3>
                    <div class="predicted-text" id="predictedText"></div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceFill" style="width: 0%">0%</div>
                    </div>
                    <div class="top5-predictions" id="top5Predictions"></div>
                    <div style="text-align: center; margin: 20px 0;">
                        <button class="tts-btn" id="ttsBtn" onclick="speakText()" disabled>
                            üîä Hear Pronunciation
                        </button>
                    </div>
                    <div class="action-buttons">
                        <button class="download-btn text" onclick="downloadText()">üìÑ Download as Text</button>
                        <button class="download-btn pdf" onclick="downloadPDF()">üìÑ Download as PDF</button>
                    </div>
                </div>

                <div class="error" id="error"></div>
            </div>

            <!-- History Sidebar -->
            <div class="history-sidebar">
                <h3>üìú Prediction History</h3>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <script>
        let currentSession = null;
        let currentMode = 'single';
        let recognizedText = '';
        let predictionHistory = [];
        let isDarkMode = false;

        // Drawing canvas setup
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // Set canvas background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 8;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        // Canvas event listeners
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Touch events for mobile
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            lastX = touch.clientX - rect.left;
            lastY = touch.clientY - rect.top;
            isDrawing = true;
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!isDrawing) return;
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const currentX = touch.clientX - rect.left;
            const currentY = touch.clientY - rect.top;
            drawLine(lastX, lastY, currentX, currentY);
            lastX = currentX;
            lastY = currentY;
        });

        canvas.addEventListener('touchend', stopDrawing);

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            drawLine(lastX, lastY, currentX, currentY);
            lastX = currentX;
            lastY = currentY;
        }

        function drawLine(x1, y1, x2, y2) {
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearCanvas() {
            ctx.fillStyle = isDarkMode ? '#2a2a3e' : 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function recognizeDrawing() {
            // Convert canvas to image and send for recognition
            canvas.toBlob((blob) => {
                const formData = new FormData();
                formData.append('image', blob, 'drawing.png');
                
                showLoading();
                hideError();
                hideResults();
                
                fetch('/upload_single', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        currentSession = data.session_id;
                        currentMode = 'draw';
                        recognize();
                    } else {
                        showError(data.error);
                    }
                })
                .catch(err => {
                    hideLoading();
                    showError('Upload failed: ' + err.message);
                });
            });
        }

        // Dark mode toggle
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            const btn = document.querySelector('.theme-toggle');
            btn.textContent = isDarkMode ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
            
            // Update canvas background
            if (!isDrawing) {
                clearCanvas();
            }
        }

        // File input handlers
        document.getElementById('singleInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                uploadSingle(e.target.files[0]);
            }
        });

        document.getElementById('multipleInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                uploadMultiple(Array.from(e.target.files));
            }
        });

        document.getElementById('pdfInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                uploadPDF(e.target.files[0]);
            }
        });

        // Drawing option click
        document.getElementById('drawOption').addEventListener('click', function() {
            document.getElementById('drawingSection').style.display = 'block';
            document.getElementById('imageViewer').style.display = 'none';
            updateActiveOption('drawOption');
            currentMode = 'draw';
        });

        function uploadSingle(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            showLoading();
            hideError();
            hideResults();
            document.getElementById('drawingSection').style.display = 'none';
            
            fetch('/upload_single', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    currentSession = data.session_id;
                    currentMode = 'single';
                    showImage(data.image, data.current_index, data.total_images);
                    updateActiveOption('singleOption');
                } else {
                    showError(data.error);
                }
            })
            .catch(err => {
                hideLoading();
                showError('Upload failed: ' + err.message);
            });
        }

        function uploadMultiple(files) {
            if (files.length > 40) {
                showError('Maximum 40 images allowed');
                return;
            }
            
            const formData = new FormData();
            files.forEach(file => formData.append('images', file));
            
            showLoading();
            hideError();
            hideResults();
            document.getElementById('drawingSection').style.display = 'none';
            
            fetch('/upload_multiple', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    currentSession = data.session_id;
                    currentMode = 'multiple';
                    showImage(data.image, data.current_index, data.total_images);
                    updateActiveOption('multipleOption');
                } else {
                    showError(data.error);
                }
            })
            .catch(err => {
                hideLoading();
                showError('Upload failed: ' + err.message);
            });
        }

        function uploadPDF(file) {
            const formData = new FormData();
            formData.append('pdf', file);
            
            showLoading();
            hideError();
            hideResults();
            document.getElementById('drawingSection').style.display = 'none';
            
            fetch('/upload_pdf', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    currentSession = data.session_id;
                    currentMode = 'pdf';
                    showImage(data.image, data.current_index, data.total_images);
                    updateActiveOption('pdfOption');
                } else {
                    showError(data.error);
                }
            })
            .catch(err => {
                hideLoading();
                showError('Upload failed: ' + err.message);
            });
        }

        function navigate(direction) {
            if (!currentSession) return;
            
            fetch('/navigate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    direction: direction
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showImage(data.image, data.current_index, data.total_images);
                    hideResults();
                } else {
                    showError(data.error);
                }
            })
            .catch(err => {
                showError('Navigation failed: ' + err.message);
            });
        }

        function recognize() {
            if (!currentSession && currentMode !== 'draw') return;
            
            showLoading();
            hideError();
            hideResults();
            
            const mode = (currentMode === 'single' || currentMode === 'draw') ? 'single' : 'sequence';
            
            fetch('/recognize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: currentSession,
                    mode: mode
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    if (data.mode === 'sequence') {
                        recognizedText = data.sequence;
                        showResults(recognizedText, data.confidence, data.top5_predictions || []);
                    } else {
                        recognizedText = data.predicted_character;
                        showResults(recognizedText, data.confidence, data.top5_predictions || []);
                    }
                    addToHistory(recognizedText, data.confidence);
                } else {
                    showError(data.error);
                }
            })
            .catch(err => {
                hideLoading();
                showError('Recognition failed: ' + err.message);
            });
        }

        function showResults(text, confidence, top5) {
            document.getElementById('predictedText').textContent = text;
            
            // Update confidence bar
            const confPercent = Math.round(confidence * 100);
            const confFill = document.getElementById('confidenceFill');
            confFill.style.width = confPercent + '%';
            confFill.textContent = confPercent + '%';
            
            // Show top-5 predictions
            const top5Div = document.getElementById('top5Predictions');
            if (top5 && top5.length > 0) {
                top5Div.innerHTML = '<h4>Top 5 Predictions:</h4>';
                top5.forEach((pred, idx) => {
                    const item = document.createElement('div');
                    item.className = 'prediction-item';
                    item.innerHTML = `
                        <span class="prediction-char">${pred.character}</span>
                        <span class="prediction-conf">${Math.round(pred.confidence * 100)}%</span>
                    `;
                    top5Div.appendChild(item);
                });
            } else {
                top5Div.innerHTML = '';
            }
            
            document.getElementById('ttsBtn').disabled = !text || text.trim() === '';
            document.getElementById('results').style.display = 'block';
        }

        function addToHistory(text, confidence) {
            const historyItem = {
                text: text,
                confidence: confidence,
                time: new Date().toLocaleTimeString()
            };
            predictionHistory.unshift(historyItem);
            if (predictionHistory.length > 20) {
                predictionHistory.pop();
            }
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            if (predictionHistory.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #666;">No predictions yet</p>';
                return;
            }
            
            predictionHistory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-char">${item.text}</div>
                    <div class="history-time">${item.time} (${Math.round(item.confidence * 100)}%)</div>
                `;
                div.onclick = () => {
                    recognizedText = item.text;
                    showResults(item.text, item.confidence, []);
                };
                historyList.appendChild(div);
            });
        }

        function showImage(imageData, currentIndex, totalImages) {
            document.getElementById('imageViewer').style.display = 'block';
            document.getElementById('imageContainer').innerHTML = 
                `<img src="data:image/png;base64,${imageData}" alt="Current image">`;
            
            document.getElementById('imageCounter').textContent = `${currentIndex + 1} / ${totalImages}`;
            document.getElementById('navigation').style.display = totalImages > 1 ? 'flex' : 'none';
            document.getElementById('recognizeBtn').disabled = false;
        }

        function speakText() {
            if (!recognizedText) return;
            
            const btn = document.getElementById('ttsBtn');
            btn.disabled = true;
            btn.textContent = 'üîä Generating Audio...';
            
            fetch('/tts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: recognizedText,
                    lang: 'kn'
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('TTS generation failed');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const audio = new Audio(url);
                audio.play();
                
                audio.onended = () => {
                    window.URL.revokeObjectURL(url);
                    btn.disabled = false;
                    btn.textContent = 'üîä Hear Pronunciation';
                };
                
                audio.onerror = () => {
                    window.URL.revokeObjectURL(url);
                    btn.disabled = false;
                    btn.textContent = 'üîä Hear Pronunciation';
                    showError('Failed to play audio');
                };
            })
            .catch(err => {
                btn.disabled = false;
                btn.textContent = 'üîä Hear Pronunciation';
                showError('TTS failed: ' + err.message);
            });
        }

        function downloadText() {
            if (!recognizedText) return;
            
            fetch('/download_text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: recognizedText
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'recognized_text.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(err => {
                showError('Download failed: ' + err.message);
            });
        }

        function downloadPDF() {
            if (!recognizedText) return;
            
            fetch('/download_pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: recognizedText
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'recognized_text.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(err => {
                showError('Download failed: ' + err.message);
            });
        }

        function hideResults() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('ttsBtn').disabled = true;
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function updateActiveOption(optionId) {
            document.querySelectorAll('.upload-option').forEach(option => {
                option.classList.remove('active');
            });
            document.getElementById(optionId).classList.add('active');
        }

        // Initialize history display
        updateHistoryDisplay();
    </script>
</body>
</html>
